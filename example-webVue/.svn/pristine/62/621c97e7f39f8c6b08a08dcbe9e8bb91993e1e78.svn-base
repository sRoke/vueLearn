<template>
  <el-dialog ref="dialog" title="新增" title-class="title-blue" class="pp1">
    <el-form ref="form" :model="form" label-width="100px">
       <el-form-item label="类型:" :label-width="formLabelWidth" prop="type" :rules="[
        { required: true, message: '类型不能为空'}]">
           <el-radio-group v-model="form.type">
             <el-row :gutter="27">
                <el-col :offset="2" :span="3">
                  <el-radio :label="1">首页</el-radio>
                </el-col>
                <el-col :offset="6" :span="3">
                  <el-radio :label="2">设计库</el-radio>
                </el-col>
                <el-col :offset="6" :span="3">
                  <el-radio :label="3">设计快讯</el-radio>
                </el-col>
              </el-row>
              <div class="margin">
                <el-row :gutter="27">
                  <el-col :offset="2" :span="3">
                    <el-radio :label="4">视频专区</el-radio>
                  </el-col>
                  <el-col :offset="6" :span="3">
                    <el-radio :label="5">经典案例</el-radio>
                  </el-col>
                </el-row>
              </div>  
            </el-radio-group>
        </el-form-item>
        <el-form-item label="图片:" :label-width="formLabelWidth" prop="img_url" :rules="[
        { required: true, message: '请上传轮播图'}]">
          <!-- <el-upload
          :action="uploadUrl"
          type="drag"
          :thumbnail-mode="true"
          :on-preview="viewPic"
          :on-remove="handleRemove"
          :on-success="uploadSuccess"
          :on-error="uploadFail"
          :default-file-list="fileList" v-model.trim="form.img_url" class="hidd">
            <i class="el-icon-upload"></i>
            <div class="el-dragger__text">将文件拖到此处，或<em>点击上传</em></div>
          <div class="el-upload__tip" slot="tip">只能上传jpg/png文件</div>
          </el-upload> -->
          <div class="ca_1">  
          <div  class="v12">
            <img :src="pic1"/>
          </div>
          <el-upload
            :action="uploadUrl"
            :on-preview="handlePreview"
            :on-success="uploadSuccess"
            :on-remove="handleRemove"
            :show-upload-list="false"
            :show-file-list="false"
            :default-file-list="fileList" class="works_img">
            <el-button size="small" type="primary">{{text1}}</el-button>
            <div class="el-upload__tip" slot="tip">只能上传jpg/png文件，且不超过500kb</div>
          </el-upload>
          </div>
        </el-form-item>
        <el-form-item label="外链Url:" :label-width="formLabelWidth" prop="visit_url">
          <el-input v-model="form.visit_url" placeholder="javascript.void(0)"></el-input>
        </el-form-item>
        <el-form-item label="启用:" :label-width="formLabelWidth" prop="start">
          <el-checkbox v-model="form.start"></el-checkbox>
        </el-form-item>
        <el-form-item label="排序:" :label-width="formLabelWidth" prop="sort">
          <el-input v-model="form.sort" placeholder="请输入0-1000的数字" class="input_mini"></el-input>
        </el-form-item>
    </el-form>
    <div slot="footer" class="dialog-footer">
      <el-button type="primary"  :disabled="disable" @click="submit()" icon="el-icon-check" :loading="isLoading">保存</el-button>
      <el-button  @click="cancel()">取消</el-button>
    </div>
    <preview ref="preview" :url="propsImg"></preview>
  </el-dialog>
</template>

<style>
  .title-blue{
    /*height: 40px;*/
    background: #0C6BC9;
  }
  .margin{
    margin-top: 10px;
    margin-bottom: 10px
  }
  .picsize{
    width: 200px;
    height: 150px;
  }
  .input_mini{
    width: 200px;
  }
</style>
<script>
import http from '../../../assets/js/http'
import preview from './preview.vue'
export default {
  props: ['info'],
  data() {
    return {
      isLoading: false,
      pic1: null,
      text1: '上传图片',
      disable: false,
      form: {
        type: '',
        // img_url: '',
        // visit_url: '',
        start: true,
        sort: ''
      },
      uploadUrl: '',
      fileList: [],
      propsImg: ''
    }
  },
  methods: {
    open() {
      this.$refs.dialog.open()
      this.isLoading = false
      this.form = { type: '',
        img_url: '',
        visit_url: '',
        start: true,
        sort: '' }
      this.fileList = []
      this.pic1 = null
    },
    cancel () {
      this.$refs.dialog.close()
    },
    submit() {
      console.log(this.form.start)
      this.$refs.form.validate((pass) => {
        if (pass) {
          this.isLoading = true
          if (this.form.sort >= 0 && this.form.sort <= 1000) {
            this.apiPost('carousels', this.form).then((res) => {
              if (res.code == 200) {
                _g.toastMsg(this, 'success', '添加成功')
                this.$refs.dialog.close()
                this.$parent.getData()
              } else {
                _g.dealError(this, res)
                this.isLoading = !this.isLoading
              }
            })
          } else {
            _g.toastMsg(this, 'warning', '排序为0-1000的数字')
            this.isLoading = !this.isLoading
          }
        }
      })
    },
    uploadSuccess(res, file, fileList) {
      // console.log('res = ',_g.j2s(res))
      // this.form.img_url = res.data
      // let data = {
      //   name: '图片',
      //   url: window.imgUrl + res.data
      // }
      // if (this.fileList.length) {
      //   this.fileList[0] = data
      // } else {
      //   this.fileList.push(data)
      // }
      this.text1 = '替换图片'
      this.form.img_url = res.data
      this.pic1 = window.imgUrl + res.data
      // console.log(this.pic1)
      // console.log(this.form.img_url)
    },
    uploadFail(err, res, file) {
      console.log('err = ', _g.j2s(err))
      console.log('res = ', _g.j2s(res))
    },
    handleRemove(file, fileList) {
      this.form.img_url = ''
      this.fileList.splice(file)
    },
    viewPic() {
      this.propsImg = this.fileList[0].url
      // 有问题
      this.$refs.preview.open()
    }
  },
  created() {
    this.uploadUrl = window.HOST + 'Upload'
  },

  components: {
    preview
  },
  mixins: [http]
}
</script>
